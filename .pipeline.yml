groups: []
resources:
- name: git
  type: git
  source:
    private_key: ((github.private_key))
    uri: git@github.com:springernature/halfpipe-deploy-resource.git
- name: cf-plugin-release
  type: github-release
  source:
    access_token: ((api-keys.halfpipe-cf-plugin))
    owner: springernature
    repository: halfpipe-cf-plugin
- name: docker-registry-image-dev
  type: docker-image
  source:
    repository: eu.gcr.io/halfpipe-io/cf-resource
    tag: dev
    password: ((gcr.private_key))
    username: _json_key
- name: docker-registry-image-stable
  type: docker-image
  source:
    repository: eu.gcr.io/halfpipe-io/cf-resource
    tag: stable
    password: ((gcr.private_key))
    username: _json_key
- name: docker-registry-image-stable-legacy
  type: docker-image
  source:
    password: ((docker-hub-pe.password))
    repository: platformengineering/cf-resource
    tag: stable
    username: platformengineering
- name: cf
  type: cf-resource
  source:
    api: ((cloudfoundry.api-snpaas))
    org: engineering-enablement
    password: ((cloudfoundry.password))
    space: integration_test
    username: ((cloudfoundry.username))
  check_every: 5s
resource_types:
- name: cf-resource
  type: registry-image
  source:
    repository: eu.gcr.io/halfpipe-io/cf-resource
    tag: dev
    password: ((gcr.private_key))
    username: _json_key

jobs:
- name: Create test docker image
  serial: true
  plan:
  - get: git
    trigger: true
  - get: cf-plugin-release
    trigger: true
  - task: Create temp folder with both resource src and plugin from release
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: alpine
      run:
        path: /bin/sh
        args:
        - -ec
        - |
          cp -r git/. build
          cp cf-plugin-release/halfpipe_cf_plugin_linux build/halfpipe_cf_plugin_linux
      inputs:
      - name: git
      - name: cf-plugin-release
      outputs:
      - name: build
  - put: docker-registry-image-dev
    params:
      build: build
      tag_file: git/.docker-dev-tag
- name: Test resource
  serial: true
  plan:
  - get: git
    passed:
    - Create test docker image
  - get: cf-plugin-release
    passed:
    - Create test docker image
  - get: docker-registry-image-dev
    passed:
    - Create test docker image
    trigger: true
  - put: cf
    params:
      appPath: git/.integration_test
      command: halfpipe-push
      gitRefPath: git/.git/ref
      manifestPath: git/.integration_test/manifest.yml
      testDomain: springernature.app
  - put: cf
    params:
      command: halfpipe-promote
      manifestPath: git/.integration_test/manifest.yml
      testDomain: springernature.app
  ensure:
    put: cf
    params:
      command: halfpipe-cleanup
      manifestPath: git/.integration_test/manifest.yml
- name: Create stable docker image
  serial: true
  plan:
  - get: git
    passed:
    - Test resource
    trigger: true
  - get: cf-plugin-release
    passed:
    - Test resource
    trigger: true
  - task: Create temp folder with both resource src and plugin from release
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: alpine
      run:
        path: /bin/sh
        args:
        - -ec
        - |
          cp -r git/. build
          cp cf-plugin-release/halfpipe_cf_plugin_linux build/halfpipe_cf_plugin_linux
      inputs:
      - name: git
      - name: cf-plugin-release
      outputs:
      - name: build
  - put: docker-registry-image-stable
    params:
      additional_tags: cf-plugin-release/tag
      build: build
      tag_file: git/.docker-stable-tag
  - put: docker-registry-image-stable-legacy
    params:
      additional_tags: cf-plugin-release/tag
      build: build
      tag_file: git/.docker-stable-tag
